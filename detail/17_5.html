<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Huazhong University of Science and Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Huazhong University of Science and Technology</h1>
    <div class="pagination">
        <a href='17_4.html'>&lt;&lt;Prev</a><a href='17.html'>1</a><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><span>[5]</span><a href='17_6.html'>6</a><a href='17_7.html'>7</a><a href='17_6.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 1c34890273a020d61d6127ade3f68ed1cb21c16a
Author: Liliang Ye &lt;yll@hust.edu.cn&gt;
Date:   Mon Apr 3 23:26:47 2023 +0800

    ASoC: fsl_mqs: move of_node_put() to the correct location
    
    of_node_put() should have been done directly after
    mqs_priv-&gt;regmap = syscon_node_to_regmap(gpr_np);
    otherwise it creates a reference leak on the success path.
    
    To fix this, of_node_put() is moved to the correct location, and change
    all the gotos to direct returns.
    
    Fixes: a9d273671440 ("ASoC: fsl_mqs: Fix error handling in probe")
    Signed-off-by: Liliang Ye &lt;yll@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Link: https://lore.kernel.org/r/20230403152647.17638-1-yll@hust.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/sound/soc/fsl/fsl_mqs.c b/sound/soc/fsl/fsl_mqs.c
index 3fb3d3e4d09a..49ae7f6267d3 100644
--- a/sound/soc/fsl/fsl_mqs.c
+++ b/sound/soc/fsl/fsl_mqs.c
@@ -210,10 +210,10 @@ static int fsl_mqs_probe(struct platform_device *pdev)
 		}
 
 		mqs_priv-&gt;regmap = syscon_node_to_regmap(gpr_np);
+		of_node_put(gpr_np);
 		if (IS_ERR(mqs_priv-&gt;regmap)) {
 			dev_err(&amp;pdev-&gt;dev, "failed to get gpr regmap\n");
-			ret = PTR_ERR(mqs_priv-&gt;regmap);
-			goto err_free_gpr_np;
+			return PTR_ERR(mqs_priv-&gt;regmap);
 		}
 	} else {
 		regs = devm_platform_ioremap_resource(pdev, 0);
@@ -242,8 +242,7 @@ static int fsl_mqs_probe(struct platform_device *pdev)
 	if (IS_ERR(mqs_priv-&gt;mclk)) {
 		dev_err(&amp;pdev-&gt;dev, "failed to get the clock: %ld\n",
 			PTR_ERR(mqs_priv-&gt;mclk));
-		ret = PTR_ERR(mqs_priv-&gt;mclk);
-		goto err_free_gpr_np;
+		return PTR_ERR(mqs_priv-&gt;mclk);
 	}
 
 	dev_set_drvdata(&amp;pdev-&gt;dev, mqs_priv);
@@ -252,13 +251,9 @@ static int fsl_mqs_probe(struct platform_device *pdev)
 	ret = devm_snd_soc_register_component(&amp;pdev-&gt;dev, &amp;soc_codec_fsl_mqs,
 			&amp;fsl_mqs_dai, 1);
 	if (ret)
-		goto err_free_gpr_np;
-	return 0;
-
-err_free_gpr_np:
-	of_node_put(gpr_np);
+		return ret;
 
-	return ret;
+	return 0;
 }
 
 static void fsl_mqs_remove(struct platform_device *pdev)</pre><hr><pre>commit 5c47cdebbaeb7724df6f9f46917c93e53f791547
Author: Jiefeng Li &lt;jiefeng_li@hust.edu.cn&gt;
Date:   Wed Apr 12 14:22:34 2023 +0800

    wifi: mt76: mt7921: fix missing unwind goto in `mt7921u_probe`
    
    `mt7921u_dma_init` can only return zero or negative number according to its
    definition. When it returns non-zero number, there exists an error and this
    function should handle this error rather than return directly.
    
    Fixes: 0d2afe09fad5 ("mt76: mt7921: add mt7921u driver")
    Signed-off-by: Jiefeng Li &lt;jiefeng_li@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Sridhar Samudrala &lt;sridhar.samudrala@intel.com&gt;
    Signed-off-by: Felix Fietkau &lt;nbd@nbd.name&gt;

diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/usb.c b/drivers/net/wireless/mediatek/mt76/mt7921/usb.c
index 9b05e4577cdf..1f302c430339 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7921/usb.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7921/usb.c
@@ -259,7 +259,7 @@ static int mt7921u_probe(struct usb_interface *usb_intf,
 
 	ret = mt7921u_dma_init(dev, false);
 	if (ret)
-		return ret;
+		goto error;
 
 	hw = mt76_hw(dev);
 	/* check hw sg support in order to enable AMSDU */</pre><hr><pre>commit c4a413e56d16a2ae84e6d8992f215c4dcc7fac20
Author: YAN SHI &lt;m202071378@hust.edu.cn&gt;
Date:   Wed Apr 12 11:35:29 2023 +0800

    regulator: stm32-pwr: fix of_iomap leak
    
    Smatch reports:
    drivers/regulator/stm32-pwr.c:166 stm32_pwr_regulator_probe() warn:
    'base' from of_iomap() not released on lines: 151,166.
    
    In stm32_pwr_regulator_probe(), base is not released
    when devm_kzalloc() fails to allocate memory or
    devm_regulator_register() fails to register a new regulator device,
    which may cause a leak.
    
    To fix this issue, replace of_iomap() with
    devm_platform_ioremap_resource(). devm_platform_ioremap_resource()
    is a specialized function for platform devices.
    It allows 'base' to be automatically released whether the probe
    function succeeds or fails.
    
    Besides, use IS_ERR(base) instead of !base
    as the return value of devm_platform_ioremap_resource()
    can either be a pointer to the remapped memory or
    an ERR_PTR() encoded error code if the operation fails.
    
    Fixes: dc62f951a6a8 ("regulator: stm32-pwr: Fix return value check in stm32_pwr_regulator_probe()")
    Signed-off-by: YAN SHI &lt;m202071378@hust.edu.cn&gt;
    Reported-by: kernel test robot &lt;lkp@intel.com&gt;
    Link: https://lore.kernel.org/oe-kbuild-all/202304111750.o2643eJN-lkp@intel.com/
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230412033529.18890-1-m202071378@hust.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/drivers/regulator/stm32-pwr.c b/drivers/regulator/stm32-pwr.c
index 2803a199826f..68aa9d92953d 100644
--- a/drivers/regulator/stm32-pwr.c
+++ b/drivers/regulator/stm32-pwr.c
@@ -129,17 +129,16 @@ static const struct regulator_desc stm32_pwr_desc[] = {
 
 static int stm32_pwr_regulator_probe(struct platform_device *pdev)
 {
-	struct device_node *np = pdev-&gt;dev.of_node;
 	struct stm32_pwr_reg *priv;
 	void __iomem *base;
 	struct regulator_dev *rdev;
 	struct regulator_config config = { };
 	int i, ret = 0;
 
-	base = of_iomap(np, 0);
-	if (!base) {
+	base = devm_platform_ioremap_resource(pdev, 0);
+	if (IS_ERR(base)) {
 		dev_err(&amp;pdev-&gt;dev, "Unable to map IO memory\n");
-		return -ENOMEM;
+		return PTR_ERR(base);
 	}
 
 	config.dev = &amp;pdev-&gt;dev;</pre><hr><pre>commit d93ee84e3eb5d1afc081e57ca37f1411a01f2c94
Author: Ying Liu &lt;lyre@hust.edu.cn&gt;
Date:   Wed Apr 12 01:09:12 2023 +0800

    ASoC: tas5720: add missing unwind goto in tas5720_codec_probe
    
    Smatch complains that missing unwind goto in tas5720_codec_probe.
    
    When tas5720 has an invalid devtype, it is expected to invoke
    regulator_bulk_disable to handle the failure. But the default
    option return an error code directly. Fix it by reusing the
    probe_fail label.
    
    Signed-off-by: Ying Liu &lt;lyre@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230411170912.1939906-1-lyre@hust.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/sound/soc/codecs/tas5720.c b/sound/soc/codecs/tas5720.c
index de6d01c8fdd3..4d27b60bd804 100644
--- a/sound/soc/codecs/tas5720.c
+++ b/sound/soc/codecs/tas5720.c
@@ -339,7 +339,8 @@ static int tas5720_codec_probe(struct snd_soc_component *component)
 		break;
 	default:
 		dev_err(component-&gt;dev, "unexpected private driver data\n");
-		return -EINVAL;
+		ret = -EINVAL;
+		goto probe_fail;
 	}
 
 	if (device_id != expected_device_id)</pre><hr><pre>commit 8bfb89f6149ea8e790f58abad1f4a84066d86c91
Author: Jun Chen &lt;jun_c@hust.edu.cn&gt;
Date:   Mon Apr 10 10:37:23 2023 +0800

    scsi: lpfc: Silence an incorrect device output
    
    In lpfc_sli4_pci_mem_unset(), case LPFC_SLI_INTF_IF_TYPE_1 does not have a
    break statement, resulting in an incorrect device output.
    
    Fix this by adding a break statement before the default option.
    
    Signed-off-by: Jun Chen &lt;jun_c@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230410023724.3209455-1-jun_c@hust.edu.cn
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Justin Tee &lt;justin.tee@broadcom.com&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index 3b0642dc023b..92e7197087bf 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -12107,6 +12107,7 @@ lpfc_sli4_pci_mem_unset(struct lpfc_hba *phba)
 			iounmap(phba-&gt;sli4_hba.dpp_regs_memmap_p);
 		break;
 	case LPFC_SLI_INTF_IF_TYPE_1:
+		break;
 	default:
 		dev_printk(KERN_ERR, &amp;phba-&gt;pcidev-&gt;dev,
 			   "FATAL - unsupported SLI4 interface type - %d\n",</pre><hr><pre>commit 91a0c0c1413239d0548b5aac4c82f38f6d53a91e
Author: Shuchang Li &lt;lishuchang@hust.edu.cn&gt;
Date:   Tue Apr 4 15:21:32 2023 +0800

    scsi: lpfc: Fix ioremap issues in lpfc_sli4_pci_mem_setup()
    
    When if_type equals zero and pci_resource_start(pdev, PCI_64BIT_BAR4)
    returns false, drbl_regs_memmap_p is not remapped. This passes a NULL
    pointer to iounmap(), which can trigger a WARN() on certain arches.
    
    When if_type equals six and pci_resource_start(pdev, PCI_64BIT_BAR4)
    returns true, drbl_regs_memmap_p may has been remapped and
    ctrl_regs_memmap_p is not remapped. This is a resource leak and passes a
    NULL pointer to iounmap().
    
    To fix these issues, we need to add null checks before iounmap(), and
    change some goto labels.
    
    Fixes: 1351e69fc6db ("scsi: lpfc: Add push-to-adapter support to sli4")
    Signed-off-by: Shuchang Li &lt;lishuchang@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230404072133.1022-1-lishuchang@hust.edu.cn
    Reviewed-by: Justin Tee &lt;justin.tee@broadcom.com&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index a9e36c73cfc5..3b0642dc023b 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -12024,7 +12024,7 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 				goto out_iounmap_all;
 		} else {
 			error = -ENOMEM;
-			goto out_iounmap_all;
+			goto out_iounmap_ctrl;
 		}
 	}
 
@@ -12042,7 +12042,7 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 			dev_err(&amp;pdev-&gt;dev,
 			   "ioremap failed for SLI4 HBA dpp registers.\n");
 			error = -ENOMEM;
-			goto out_iounmap_ctrl;
+			goto out_iounmap_all;
 		}
 		phba-&gt;pci_bar4_memmap_p = phba-&gt;sli4_hba.dpp_regs_memmap_p;
 	}
@@ -12067,9 +12067,11 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 	return 0;
 
 out_iounmap_all:
-	iounmap(phba-&gt;sli4_hba.drbl_regs_memmap_p);
+	if (phba-&gt;sli4_hba.drbl_regs_memmap_p)
+		iounmap(phba-&gt;sli4_hba.drbl_regs_memmap_p);
 out_iounmap_ctrl:
-	iounmap(phba-&gt;sli4_hba.ctrl_regs_memmap_p);
+	if (phba-&gt;sli4_hba.ctrl_regs_memmap_p)
+		iounmap(phba-&gt;sli4_hba.ctrl_regs_memmap_p);
 out_iounmap_conf:
 	iounmap(phba-&gt;sli4_hba.conf_regs_memmap_p);
 </pre><hr><pre>commit fb4a624f88f658c7b7ae124452bd42eaa8ac7168
Author: Xu Biang &lt;xubiang@hust.edu.cn&gt;
Date:   Thu Apr 6 06:28:01 2023 -0700

    ALSA: firewire-tascam: add missing unwind goto in snd_tscm_stream_start_duplex()
    
    Smatch Warns:
    sound/firewire/tascam/tascam-stream.c:493 snd_tscm_stream_start_duplex()
    warn: missing unwind goto?
    
    The direct return will cause the stream list of "&amp;tscm-&gt;domain" unemptied
    and the session in "tscm" unfinished if amdtp_domain_start() returns with
    an error.
    
    Fix this by changing the direct return to a goto which will empty the
    stream list of "&amp;tscm-&gt;domain" and finish the session in "tscm".
    
    The snd_tscm_stream_start_duplex() function is called in the prepare
    callback of PCM. According to "ALSA Kernel API Documentation", the prepare
    callback of PCM will be called many times at each setup. So, if the
    "&amp;d-&gt;streams" list is not emptied, when the prepare callback is called
    next time, snd_tscm_stream_start_duplex() will receive -EBUSY from
    amdtp_domain_add_stream() that tries to add an existing stream to the
    domain. The error handling code after the "error" label will be executed
    in this case, and the "&amp;d-&gt;streams" list will be emptied. So not emptying
    the "&amp;d-&gt;streams" list will not cause an issue. But it is more efficient
    and readable to empty it on the first error by changing the direct return
    to a goto statement.
    
    The session in "tscm" has been begun before amdtp_domain_start(), so it
    needs to be finished when amdtp_domain_start() fails.
    
    Fixes: c281d46a51e3 ("ALSA: firewire-tascam: support AMDTP domain")
    Signed-off-by: Xu Biang &lt;xubiang@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Acked-by: Takashi Sakamoto &lt;o-takashi@sakamocchi.jp&gt;
    Cc: &lt;stable@vger.kernel.org&gt;
    Link: https://lore.kernel.org/r/20230406132801.105108-1-xubiang@hust.edu.cn
    Signed-off-by: Takashi Iwai &lt;tiwai@suse.de&gt;

diff --git a/sound/firewire/tascam/tascam-stream.c b/sound/firewire/tascam/tascam-stream.c
index 53e094cc411f..dfe783d01d7d 100644
--- a/sound/firewire/tascam/tascam-stream.c
+++ b/sound/firewire/tascam/tascam-stream.c
@@ -490,7 +490,7 @@ int snd_tscm_stream_start_duplex(struct snd_tscm *tscm, unsigned int rate)
 		// packet is important for media clock recovery.
 		err = amdtp_domain_start(&amp;tscm-&gt;domain, tx_init_skip_cycles, true, true);
 		if (err &lt; 0)
-			return err;
+			goto error;
 
 		if (!amdtp_domain_wait_ready(&amp;tscm-&gt;domain, READY_TIMEOUT_MS)) {
 			err = -ETIMEDOUT;</pre><hr><pre>commit 194f8692302cbf31d8072f3fc2710fb04720d8a0
Author: Zihao Wang &lt;u202012060@hust.edu.cn&gt;
Date:   Tue Apr 4 16:46:22 2023 +0800

    ASoC: tegra20_ac97: Add missing unwind goto in tegra20_ac97_platform_probe()
    
    Smatch Warns:
            sound/soc/tegra/tegra20_ac97.c:321 tegra20_ac97_platform_probe()
            warn: missing unwind goto?
    
    The goto will set the "soc_ac97_ops" and "soc_ac97_bus" operations to
    NULL.  But they are already NULL at this point so it is a no-op.
    However, just for consistency, change the direct return to a goto.  No
    functional change.
    
    Signed-off-by: Zihao Wang &lt;u202012060@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Link: https://lore.kernel.org/r/20230404084622.1202-1-u202012060@hust.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/sound/soc/tegra/tegra20_ac97.c b/sound/soc/tegra/tegra20_ac97.c
index fea6955f7f43..c498145e76e0 100644
--- a/sound/soc/tegra/tegra20_ac97.c
+++ b/sound/soc/tegra/tegra20_ac97.c
@@ -318,7 +318,8 @@ static int tegra20_ac97_platform_probe(struct platform_device *pdev)
 	ac97-&gt;reset = devm_reset_control_get_exclusive(&amp;pdev-&gt;dev, "ac97");
 	if (IS_ERR(ac97-&gt;reset)) {
 		dev_err(&amp;pdev-&gt;dev, "Can't retrieve ac97 reset\n");
-		return PTR_ERR(ac97-&gt;reset);
+		ret = PTR_ERR(ac97-&gt;reset);
+		goto err;
 	}
 
 	ac97-&gt;clk_ac97 = devm_clk_get(&amp;pdev-&gt;dev, NULL);</pre><hr><pre>commit fc187a46a8e682f0f1167b230792b88de01ceaa0
Author: Li Yang &lt;lidaxian@hust.edu.cn&gt;
Date:   Fri Mar 31 17:55:44 2023 +0800

    soc: renesas: renesas-soc: Release 'chipid' from ioremap()
    
    Smatch reports:
    
    drivers/soc/renesas/renesas-soc.c:536 renesas_soc_init() warn:
    'chipid' from ioremap() not released on lines: 475.
    
    If soc_dev_atrr allocation is failed, function renesas_soc_init()
    will return without releasing 'chipid' from ioremap().
    
    Fix this by adding function iounmap().
    
    Fixes: cb5508e47e60 ("soc: renesas: Add support for reading product revision for RZ/G2L family")
    Signed-off-by: Li Yang &lt;lidaxian@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Geert Uytterhoeven &lt;geert+renesas@glider.be&gt;
    Link: https://lore.kernel.org/r/20230331095545.31823-1-lidaxian@hust.edu.cn
    Signed-off-by: Geert Uytterhoeven &lt;geert+renesas@glider.be&gt;

diff --git a/drivers/soc/renesas/renesas-soc.c b/drivers/soc/renesas/renesas-soc.c
index 4ba893e45427..42af7c09f743 100644
--- a/drivers/soc/renesas/renesas-soc.c
+++ b/drivers/soc/renesas/renesas-soc.c
@@ -469,8 +469,11 @@ static int __init renesas_soc_init(void)
 	}
 
 	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
-	if (!soc_dev_attr)
+	if (!soc_dev_attr) {
+		if (chipid)
+			iounmap(chipid);
 		return -ENOMEM;
+	}
 
 	np = of_find_node_by_path("/");
 	of_property_read_string(np, "model", &amp;soc_dev_attr-&gt;machine);</pre><hr><pre>commit c3fbced9af885a6f217fd95509a613d6590916ce
Author: Zhaoyang Li &lt;lizhaoyang04@hust.edu.cn&gt;
Date:   Mon Mar 27 19:54:22 2023 +0800

    soc: bcm: brcmstb: biuctrl: fix of_iomap leak
    
    Smatch reports:
    
    drivers/soc/bcm/brcmstb/biuctrl.c:291 setup_hifcpubiuctrl_regs() warn:
    'cpubiuctrl_base' from of_iomap() not released on lines: 291.
    
    This is because in setup_hifcpubiuctrl_regs(),
    cpubiuctrl_base is not released when handle error, which may cause a leak.
    To fix this, iounmap is added when handle error.
    
    Fixes: 22f7a9116eba ("soc: brcmstb: Correct CPU_CREDIT_REG offset for Brahma-B53 CPUs")
    Signed-off-by: Zhaoyang Li &lt;lizhaoyang04@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230327115422.1536615-1-lizhaoyang04@hust.edu.cn
    Signed-off-by: Florian Fainelli &lt;f.fainelli@gmail.com&gt;

diff --git a/drivers/soc/bcm/brcmstb/biuctrl.c b/drivers/soc/bcm/brcmstb/biuctrl.c
index e1d7b4543248..364ddbe365c2 100644
--- a/drivers/soc/bcm/brcmstb/biuctrl.c
+++ b/drivers/soc/bcm/brcmstb/biuctrl.c
@@ -288,6 +288,10 @@ static int __init setup_hifcpubiuctrl_regs(struct device_node *np)
 	if (BRCM_ID(family_id) == 0x7260 &amp;&amp; BRCM_REV(family_id) == 0)
 		cpubiuctrl_regs = b53_cpubiuctrl_no_wb_regs;
 out:
+	if (ret &amp;&amp; cpubiuctrl_base) {
+		iounmap(cpubiuctrl_base);
+		cpubiuctrl_base = NULL;
+	}
 	return ret;
 }
 </pre>
    <div class="pagination">
        <a href='17_4.html'>&lt;&lt;Prev</a><a href='17.html'>1</a><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><span>[5]</span><a href='17_6.html'>6</a><a href='17_7.html'>7</a><a href='17_6.html'>Next&gt;&gt;</a>
    <div>
</body>
