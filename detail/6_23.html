<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Zhejiang University</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Zhejiang University</h1>
    <div class="pagination">
        <a href='6_22.html'>&lt;&lt;Prev</a><a href='6.html'>1</a><a href='6_2.html'>2</a><a href='6_3.html'>3</a><a href='6_4.html'>4</a><a href='6_5.html'>5</a><a href='6_6.html'>6</a><a href='6_7.html'>7</a><a href='6_8.html'>8</a><a href='6_9.html'>9</a><a href='6_10.html'>10</a><a href='6_11.html'>11</a><a href='6_12.html'>12</a><a href='6_13.html'>13</a><a href='6_14.html'>14</a><a href='6_15.html'>15</a><a href='6_16.html'>16</a><a href='6_17.html'>17</a><a href='6_18.html'>18</a><a href='6_19.html'>19</a><a href='6_20.html'>20</a><a href='6_21.html'>21</a><a href='6_22.html'>22</a><span>[23]</span><a href='6_24.html'>24</a><a href='6_25.html'>25</a><a href='6_26.html'>26</a><a href='6_27.html'>27</a><a href='6_28.html'>28</a><a href='6_29.html'>29</a><a href='6_30.html'>30</a><a href='6_31.html'>31</a><a href='6_32.html'>32</a><a href='6_33.html'>33</a><a href='6_34.html'>34</a><a href='6_24.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 6dbbbe4cfd398704b72b21c1d4a5d3807e909d60
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Mon Mar 1 16:04:21 2021 +0800

    iio: gyro: mpu3050: Fix error handling in mpu3050_trigger_handler
    
    There is one regmap_bulk_read() call in mpu3050_trigger_handler
    that we have caught its return value bug lack further handling.
    Check and terminate the execution flow just like the other three
    regmap_bulk_read() calls in this function.
    
    Fixes: 3904b28efb2c7 ("iio: gyro: Add driver for the MPU-3050 gyroscope")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Reviewed-by: Linus Walleij &lt;linus.walleij@linaro.org&gt;
    Link: https://lore.kernel.org/r/20210301080421.13436-1-dinghao.liu@zju.edu.cn
    Cc: &lt;Stable@vger.kernel.org&gt;
    Signed-off-by: Jonathan Cameron &lt;Jonathan.Cameron@huawei.com&gt;

diff --git a/drivers/iio/gyro/mpu3050-core.c b/drivers/iio/gyro/mpu3050-core.c
index dfa31a23500f..ac90be03332a 100644
--- a/drivers/iio/gyro/mpu3050-core.c
+++ b/drivers/iio/gyro/mpu3050-core.c
@@ -551,6 +551,8 @@ static irqreturn_t mpu3050_trigger_handler(int irq, void *p)
 					       MPU3050_FIFO_R,
 					       &amp;fifo_values[offset],
 					       toread);
+			if (ret)
+				goto out_trigger_unlock;
 
 			dev_dbg(mpu3050-&gt;dev,
 				"%04x %04x %04x %04x %04x\n",</pre><hr><pre>commit 7a766381634da19fc837619b0a34590498d9d29a
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sun Jan 3 16:08:42 2021 +0800

    ixgbe: Fix memleak in ixgbe_configure_clsu32
    
    When ixgbe_fdir_write_perfect_filter_82599() fails,
    input allocated by kzalloc() has not been freed,
    which leads to memleak.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Reviewed-by: Paul Menzel &lt;pmenzel@molgen.mpg.de&gt;
    Tested-by: Tony Brelinski &lt;tonyx.brelinski@intel.com&gt;
    Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;

diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
index fae84202d870..9f3f12e2ccf2 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
@@ -9565,8 +9565,10 @@ static int ixgbe_configure_clsu32(struct ixgbe_adapter *adapter,
 	ixgbe_atr_compute_perfect_hash_82599(&amp;input-&gt;filter, mask);
 	err = ixgbe_fdir_write_perfect_filter_82599(hw, &amp;input-&gt;filter,
 						    input-&gt;sw_idx, queue);
-	if (!err)
-		ixgbe_update_ethtool_fdir_entry(adapter, input, input-&gt;sw_idx);
+	if (err)
+		goto err_out_w_lock;
+
+	ixgbe_update_ethtool_fdir_entry(adapter, input, input-&gt;sw_idx);
 	spin_unlock(&amp;adapter-&gt;fdir_perfect_lock);
 
 	if ((uhtid != 0x800) &amp;&amp; (adapter-&gt;jump_tables[uhtid]))</pre><hr><pre>commit 11b8ab3836454a2600e396f34731e491b661f9d5
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Tue Jan 5 14:03:40 2021 +0800

    ubifs: Fix memleak in ubifs_init_authentication
    
    When crypto_shash_digestsize() fails, c-&gt;hmac_tfm
    has not been freed before returning, which leads
    to memleak.
    
    Fixes: 49525e5eecca5 ("ubifs: Add helper functions for authentication support")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Reviewed-by: Zhihao Cheng &lt;chengzhihao1@huawei.com&gt;
    Signed-off-by: Richard Weinberger &lt;richard@nod.at&gt;

diff --git a/fs/ubifs/auth.c b/fs/ubifs/auth.c
index 51a7c8c2c3f0..e564d5ff8781 100644
--- a/fs/ubifs/auth.c
+++ b/fs/ubifs/auth.c
@@ -327,7 +327,7 @@ int ubifs_init_authentication(struct ubifs_info *c)
 		ubifs_err(c, "hmac %s is bigger than maximum allowed hmac size (%d &gt; %d)",
 			  hmac_name, c-&gt;hmac_desc_len, UBIFS_HMAC_ARR_SZ);
 		err = -EINVAL;
-		goto out_free_hash;
+		goto out_free_hmac;
 	}
 
 	err = crypto_shash_setkey(c-&gt;hmac_tfm, ukp-&gt;data, ukp-&gt;datalen);</pre><hr><pre>commit 0074946932cbd42647da947408a9d620746a4e0e
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sun Jan 31 18:09:14 2021 +0800

    ALSA: intel8x0: Fix missing check in snd_intel8x0m_create
    
    When device_type == DEVICE_ALI, we should also check the return
    value of pci_iomap() to avoid potential null pointer dereference.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Link: https://lore.kernel.org/r/20210131100916.7915-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Takashi Iwai &lt;tiwai@suse.de&gt;

diff --git a/sound/pci/intel8x0m.c b/sound/pci/intel8x0m.c
index 1b7df0c4e57c..19872cecc9d2 100644
--- a/sound/pci/intel8x0m.c
+++ b/sound/pci/intel8x0m.c
@@ -1129,13 +1129,14 @@ static int snd_intel8x0m_create(struct snd_card *card,
 		chip-&gt;bmaddr = pci_iomap(pci, 3, 0);
 	else
 		chip-&gt;bmaddr = pci_iomap(pci, 1, 0);
+
+port_inited:
 	if (!chip-&gt;bmaddr) {
 		dev_err(card-&gt;dev, "Controller space ioremap problem\n");
 		snd_intel8x0m_free(chip);
 		return -EIO;
 	}
 
- port_inited:
 	/* initialize offsets */
 	chip-&gt;bdbars_count = 2;
 	tbl = intel_regs;</pre><hr><pre>commit ef49d40b61a3e18a11edd5eb1c30b0183af9e850
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sun Jan 17 16:50:17 2021 +0800

    block: Fix an error handling in add_partition
    
    Once we have called device_initialize(), we should use put_device() to
    give up the reference on error, just like what we have done on failure
    of device_add().
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Reviewed-by: Christoph Hellwig &lt;hch@lst.de&gt;
    Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;

diff --git a/block/partitions/core.c b/block/partitions/core.c
index e7d776db803b..23460cee9de5 100644
--- a/block/partitions/core.c
+++ b/block/partitions/core.c
@@ -384,7 +384,7 @@ static struct block_device *add_partition(struct gendisk *disk, int partno,
 
 	err = blk_alloc_devt(bdev, &amp;devt);
 	if (err)
-		goto out_bdput;
+		goto out_put;
 	pdev-&gt;devt = devt;
 
 	/* delay uevent until 'holders' subdir is created */</pre><hr><pre>commit ccf11dbaa07b328fa469415c362d33459c140a37
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sun Jan 10 16:02:53 2021 +0800

    evm: Fix memleak in init_desc
    
    tmp_tfm is allocated, but not freed on subsequent kmalloc failure, which
    leads to a memory leak.  Free tmp_tfm.
    
    Fixes: d46eb3699502b ("evm: crypto hash replaced by shash")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    [zohar@linux.ibm.com: formatted/reworded patch description]
    Signed-off-by: Mimi Zohar &lt;zohar@linux.ibm.com&gt;

diff --git a/security/integrity/evm/evm_crypto.c b/security/integrity/evm/evm_crypto.c
index 168c3b78ac47..a6dd47eb086d 100644
--- a/security/integrity/evm/evm_crypto.c
+++ b/security/integrity/evm/evm_crypto.c
@@ -73,7 +73,7 @@ static struct shash_desc *init_desc(char type, uint8_t hash_algo)
 {
 	long rc;
 	const char *algo;
-	struct crypto_shash **tfm, *tmp_tfm;
+	struct crypto_shash **tfm, *tmp_tfm = NULL;
 	struct shash_desc *desc;
 
 	if (type == EVM_XATTR_HMAC) {
@@ -118,13 +118,16 @@ static struct shash_desc *init_desc(char type, uint8_t hash_algo)
 alloc:
 	desc = kmalloc(sizeof(*desc) + crypto_shash_descsize(*tfm),
 			GFP_KERNEL);
-	if (!desc)
+	if (!desc) {
+		crypto_free_shash(tmp_tfm);
 		return ERR_PTR(-ENOMEM);
+	}
 
 	desc-&gt;tfm = *tfm;
 
 	rc = crypto_shash_init(desc);
 	if (rc) {
+		crypto_free_shash(tmp_tfm);
 		kfree(desc);
 		return ERR_PTR(rc);
 	}</pre><hr><pre>commit d6e3ae76728ccde49271d9f5acfebbea0c5625a3
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Fri Dec 25 16:35:20 2020 +0800

    scsi: fnic: Fix memleak in vnic_dev_init_devcmd2
    
    When ioread32() returns 0xFFFFFFFF, we should execute cleanup functions
    like other error handling paths before returning.
    
    Link: https://lore.kernel.org/r/20201225083520.22015-1-dinghao.liu@zju.edu.cn
    Acked-by: Karan Tilak Kumar &lt;kartilak@cisco.com&gt;
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/fnic/vnic_dev.c b/drivers/scsi/fnic/vnic_dev.c
index a2beee6e09f0..5988c300cc82 100644
--- a/drivers/scsi/fnic/vnic_dev.c
+++ b/drivers/scsi/fnic/vnic_dev.c
@@ -444,7 +444,8 @@ static int vnic_dev_init_devcmd2(struct vnic_dev *vdev)
 	fetch_index = ioread32(&amp;vdev-&gt;devcmd2-&gt;wq.ctrl-&gt;fetch_index);
 	if (fetch_index == 0xFFFFFFFF) { /* check for hardware gone  */
 		pr_err("error in devcmd2 init");
-		return -ENODEV;
+		err = -ENODEV;
+		goto err_free_wq;
 	}
 
 	/*
@@ -460,7 +461,7 @@ static int vnic_dev_init_devcmd2(struct vnic_dev *vdev)
 	err = vnic_dev_alloc_desc_ring(vdev, &amp;vdev-&gt;devcmd2-&gt;results_ring,
 			DEVCMD2_RING_SIZE, DEVCMD2_DESC_SIZE);
 	if (err)
-		goto err_free_wq;
+		goto err_disable_wq;
 
 	vdev-&gt;devcmd2-&gt;result =
 		(struct devcmd2_result *) vdev-&gt;devcmd2-&gt;results_ring.descs;
@@ -481,8 +482,9 @@ static int vnic_dev_init_devcmd2(struct vnic_dev *vdev)
 
 err_free_desc_ring:
 	vnic_dev_free_desc_ring(vdev, &amp;vdev-&gt;devcmd2-&gt;results_ring);
-err_free_wq:
+err_disable_wq:
 	vnic_wq_disable(&amp;vdev-&gt;devcmd2-&gt;wq);
+err_free_wq:
 	vnic_wq_free(&amp;vdev-&gt;devcmd2-&gt;wq);
 err_free_devcmd2:
 	kfree(vdev-&gt;devcmd2);</pre><hr><pre>commit 76aaf8a96771c16365b8510f1fb97738dc88026e
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sat Jan 2 09:26:37 2021 +0100

    media: tm6000: Fix memleak in tm6000_start_stream
    
    When usb_clear_halt() fails, dvb-&gt;bulk_urb-&gt;transfer_buffer
    and dvb-&gt;bulk_urb should be freed just like when
    usb_submit_urb() fails.
    
    Fixes: 3169c9b26fffa ("V4L/DVB (12788): tm6000: Add initial DVB-T support")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
    Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;

diff --git a/drivers/media/usb/tm6000/tm6000-dvb.c b/drivers/media/usb/tm6000/tm6000-dvb.c
index 19c90fa9e443..293a460f4616 100644
--- a/drivers/media/usb/tm6000/tm6000-dvb.c
+++ b/drivers/media/usb/tm6000/tm6000-dvb.c
@@ -141,6 +141,10 @@ static int tm6000_start_stream(struct tm6000_core *dev)
 	if (ret &lt; 0) {
 		printk(KERN_ERR "tm6000: error %i in %s during pipe reset\n",
 							ret, __func__);
+
+		kfree(dvb-&gt;bulk_urb-&gt;transfer_buffer);
+		usb_free_urb(dvb-&gt;bulk_urb);
+		dvb-&gt;bulk_urb = NULL;
 		return ret;
 	} else
 		printk(KERN_ERR "tm6000: pipe reset\n");</pre><hr><pre>commit 15d0c52241ecb1c9d802506bff6f5c3f7872c0df
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Sat Jan 2 07:27:22 2021 +0100

    media: media/pci: Fix memleak in empress_init
    
    When vb2_queue_init() fails, dev-&gt;empress_dev
    should be released just like other error handling
    paths.
    
    Fixes: 2ada815fc48bb ("[media] saa7134: convert to vb2")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
    Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;

diff --git a/drivers/media/pci/saa7134/saa7134-empress.c b/drivers/media/pci/saa7134/saa7134-empress.c
index 39e3c7f8c5b4..76a37fbd8458 100644
--- a/drivers/media/pci/saa7134/saa7134-empress.c
+++ b/drivers/media/pci/saa7134/saa7134-empress.c
@@ -282,8 +282,11 @@ static int empress_init(struct saa7134_dev *dev)
 	q-&gt;lock = &amp;dev-&gt;lock;
 	q-&gt;dev = &amp;dev-&gt;pci-&gt;dev;
 	err = vb2_queue_init(q);
-	if (err)
+	if (err) {
+		video_device_release(dev-&gt;empress_dev);
+		dev-&gt;empress_dev = NULL;
 		return err;
+	}
 	dev-&gt;empress_dev-&gt;queue = q;
 	dev-&gt;empress_dev-&gt;device_caps = V4L2_CAP_READWRITE | V4L2_CAP_STREAMING |
 					V4L2_CAP_VIDEO_CAPTURE;</pre><hr><pre>commit a26efd1961a18b91ae4cd2e433adbcf865b40fa3
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Mon Dec 28 14:02:05 2020 +0100

    media: em28xx: Fix use-after-free in em28xx_alloc_urbs
    
    When kzalloc() fails, em28xx_uninit_usb_xfer() will free
    usb_bufs-&gt;buf and set it to NULL. Thus the later access
    to usb_bufs-&gt;buf[i] will lead to null pointer dereference.
    Also the kfree(usb_bufs-&gt;buf) after that is redundant.
    
    Fixes: d571b592c6206 ("media: em28xx: don't use coherent buffer for DMA transfers")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
    Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;

diff --git a/drivers/media/usb/em28xx/em28xx-core.c b/drivers/media/usb/em28xx/em28xx-core.c
index e6088b5d1b80..3daa64bb1e1d 100644
--- a/drivers/media/usb/em28xx/em28xx-core.c
+++ b/drivers/media/usb/em28xx/em28xx-core.c
@@ -956,14 +956,10 @@ int em28xx_alloc_urbs(struct em28xx *dev, enum em28xx_mode mode, int xfer_bulk,
 
 		usb_bufs-&gt;buf[i] = kzalloc(sb_size, GFP_KERNEL);
 		if (!usb_bufs-&gt;buf[i]) {
-			em28xx_uninit_usb_xfer(dev, mode);
-
 			for (i--; i &gt;= 0; i--)
 				kfree(usb_bufs-&gt;buf[i]);
 
-			kfree(usb_bufs-&gt;buf);
-			usb_bufs-&gt;buf = NULL;
-
+			em28xx_uninit_usb_xfer(dev, mode);
 			return -ENOMEM;
 		}
 </pre>
    <div class="pagination">
        <a href='6_22.html'>&lt;&lt;Prev</a><a href='6.html'>1</a><a href='6_2.html'>2</a><a href='6_3.html'>3</a><a href='6_4.html'>4</a><a href='6_5.html'>5</a><a href='6_6.html'>6</a><a href='6_7.html'>7</a><a href='6_8.html'>8</a><a href='6_9.html'>9</a><a href='6_10.html'>10</a><a href='6_11.html'>11</a><a href='6_12.html'>12</a><a href='6_13.html'>13</a><a href='6_14.html'>14</a><a href='6_15.html'>15</a><a href='6_16.html'>16</a><a href='6_17.html'>17</a><a href='6_18.html'>18</a><a href='6_19.html'>19</a><a href='6_20.html'>20</a><a href='6_21.html'>21</a><a href='6_22.html'>22</a><span>[23]</span><a href='6_24.html'>24</a><a href='6_25.html'>25</a><a href='6_26.html'>26</a><a href='6_27.html'>27</a><a href='6_28.html'>28</a><a href='6_29.html'>29</a><a href='6_30.html'>30</a><a href='6_31.html'>31</a><a href='6_32.html'>32</a><a href='6_33.html'>33</a><a href='6_34.html'>34</a><a href='6_24.html'>Next&gt;&gt;</a>
    <div>
</body>
