<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Huazhong University of Science and Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Huazhong University of Science and Technology</h1>
    <div class="pagination">
        <a href='17_5.html'>&lt;&lt;Prev</a><a href='17.html'>1</a><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><a href='17_5.html'>5</a><span>[6]</span><a href='17_7.html'>7</a><a href='17_7.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit db2c2b161d4a8f4a81e6f643848b1531517a67a5
Author: Mingxuan Xiang &lt;mx_xiang@hust.edu.cn&gt;
Date:   Fri Mar 24 14:09:34 2023 +0800

    usb: dwc3: host: remove dead code in dwc3_host_get_irq()
    
    According to the description of platform_get_irq()
     * Return: non-zero IRQ number on success,
                            negative error number on failure.
    and the code, platform_get_irq() will return -EINVAL
    instead of IRQ0.
    
    So platform_get_irq() no longer returns 0, there is no
    need to check whether the return value is 0.
    
    Found by Smatch:
    drivers/usb/dwc3/host.c:60 dwc3_host_get_irq()
            warn: platform_get_irq() does not return zero
    
    Signed-off-by: Mingxuan Xiang &lt;mx_xiang@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Acked-by: Thinh Nguyen &lt;Thinh.Nguyen@synopsys.com&gt;
    Link: https://lore.kernel.org/r/20230324060934.1686859-1-mx_xiang@hust.edu.cn
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;

diff --git a/drivers/usb/dwc3/host.c b/drivers/usb/dwc3/host.c
index f6f13e7f1ba1..61f57fe5bb78 100644
--- a/drivers/usb/dwc3/host.c
+++ b/drivers/usb/dwc3/host.c
@@ -52,13 +52,8 @@ static int dwc3_host_get_irq(struct dwc3 *dwc)
 		goto out;
 
 	irq = platform_get_irq(dwc3_pdev, 0);
-	if (irq &gt; 0) {
+	if (irq &gt; 0)
 		dwc3_host_fill_xhci_irq_res(dwc, irq, NULL);
-		goto out;
-	}
-
-	if (!irq)
-		irq = -EINVAL;
 
 out:
 	return irq;</pre><hr><pre>commit f33642224e38d7e0d59336e10e7b4e370b1c4506
Author: SongJingyi &lt;u201912584@hust.edu.cn&gt;
Date:   Fri Mar 24 11:14:06 2023 +0800

    ptp_qoriq: fix memory leak in probe()
    
    Smatch complains that:
    drivers/ptp/ptp_qoriq.c ptp_qoriq_probe()
    warn: 'base' from ioremap() not released.
    
    Fix this by revising the parameter from 'ptp_qoriq-&gt;base' to 'base'.
    This is only a bug if ptp_qoriq_init() returns on the
    first -ENODEV error path.
    For other error paths ptp_qoriq-&gt;base and base are the same.
    And this change makes the code more readable.
    
    Fixes: 7f4399ba405b ("ptp_qoriq: fix NULL access if ptp dt node missing")
    Signed-off-by: SongJingyi &lt;u201912584@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230324031406.1895159-1-u201912584@hust.edu.cn
    Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;

diff --git a/drivers/ptp/ptp_qoriq.c b/drivers/ptp/ptp_qoriq.c
index 61530167efe4..350154e4c2b5 100644
--- a/drivers/ptp/ptp_qoriq.c
+++ b/drivers/ptp/ptp_qoriq.c
@@ -637,7 +637,7 @@ static int ptp_qoriq_probe(struct platform_device *dev)
 	return 0;
 
 no_clock:
-	iounmap(ptp_qoriq-&gt;base);
+	iounmap(base);
 no_ioremap:
 	release_resource(ptp_qoriq-&gt;rsrc);
 no_resource:</pre><hr><pre>commit 813cc94c7847ae4a17e9f744fb4dbdf7df6bd732
Author: Tianyi Jing &lt;jingfelix@hust.edu.cn&gt;
Date:   Sat Mar 18 22:38:51 2023 +0800

    hwmon: (xgene) Fix ioremap and memremap leak
    
    Smatch reports:
    
    drivers/hwmon/xgene-hwmon.c:757 xgene_hwmon_probe() warn:
    'ctx-&gt;pcc_comm_addr' from ioremap() not released on line: 757.
    
    This is because in drivers/hwmon/xgene-hwmon.c:701 xgene_hwmon_probe(),
    ioremap and memremap is not released, which may cause a leak.
    
    To fix this, ioremap and memremap is modified to devm_ioremap and
    devm_memremap.
    
    Signed-off-by: Tianyi Jing &lt;jingfelix@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230318143851.2191625-1-jingfelix@hust.edu.cn
    [groeck: Fixed formatting and subject]
    Signed-off-by: Guenter Roeck &lt;linux@roeck-us.net&gt;

diff --git a/drivers/hwmon/xgene-hwmon.c b/drivers/hwmon/xgene-hwmon.c
index d1abea49f01b..78d9f52e2a71 100644
--- a/drivers/hwmon/xgene-hwmon.c
+++ b/drivers/hwmon/xgene-hwmon.c
@@ -698,14 +698,14 @@ static int xgene_hwmon_probe(struct platform_device *pdev)
 		ctx-&gt;comm_base_addr = pcc_chan-&gt;shmem_base_addr;
 		if (ctx-&gt;comm_base_addr) {
 			if (version == XGENE_HWMON_V2)
-				ctx-&gt;pcc_comm_addr = (void __force *)ioremap(
-							ctx-&gt;comm_base_addr,
-							pcc_chan-&gt;shmem_size);
+				ctx-&gt;pcc_comm_addr = (void __force *)devm_ioremap(&amp;pdev-&gt;dev,
+								  ctx-&gt;comm_base_addr,
+								  pcc_chan-&gt;shmem_size);
 			else
-				ctx-&gt;pcc_comm_addr = memremap(
-							ctx-&gt;comm_base_addr,
-							pcc_chan-&gt;shmem_size,
-							MEMREMAP_WB);
+				ctx-&gt;pcc_comm_addr = devm_memremap(&amp;pdev-&gt;dev,
+								   ctx-&gt;comm_base_addr,
+								   pcc_chan-&gt;shmem_size,
+								   MEMREMAP_WB);
 		} else {
 			dev_err(&amp;pdev-&gt;dev, "Failed to get PCC comm region\n");
 			rc = -ENODEV;</pre><hr><pre>commit 8d13d50b157655247cdb3a69aca7836b58ff8735
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Thu Mar 9 12:01:06 2023 +0800

    platform/x86/intel: tpmi: Revise the comment of intel_vsec_add_aux
    
    intel_vsec_add_aux() is resource managed including res and
    feature_vsec_dev memory.
    
    Fix this by revising the comment of intel_vsec_add_aux since res variable
    will also be freed in the intel_vsec_add_aux.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230309040107.534716-3-dzm91@hust.edu.cn
    Reviewed-by: Hans de Goede &lt;hdegoede@redhat.com&gt;
    Signed-off-by: Hans de Goede &lt;hdegoede@redhat.com&gt;

diff --git a/drivers/platform/x86/intel/tpmi.c b/drivers/platform/x86/intel/tpmi.c
index a8733c43e4ab..a5227951decc 100644
--- a/drivers/platform/x86/intel/tpmi.c
+++ b/drivers/platform/x86/intel/tpmi.c
@@ -239,8 +239,8 @@ static int tpmi_create_device(struct intel_tpmi_info *tpmi_info,
 	/*
 	 * intel_vsec_add_aux() is resource managed, no explicit
 	 * delete is required on error or on module unload.
-	 * feature_vsec_dev memory is also freed as part of device
-	 * delete.
+	 * feature_vsec_dev and res memory are also freed as part of
+	 * device deletion.
 	 */
 	return intel_vsec_add_aux(vsec_dev-&gt;pcidev, &amp;vsec_dev-&gt;auxdev.dev,
 				  feature_vsec_dev, feature_id_name);</pre><hr><pre>commit 4d5a2a7d2c97dbd658533eea5f79dab1ad5dc0ee
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Thu Mar 9 12:01:05 2023 +0800

    platform/x86/intel: tpmi: Fix double free in tpmi_create_device()
    
    The previous commit 6a192c0cbf38 ("platform/x86/intel/tpmi: Fix
    double free reported by Smatch") incorrectly handle the deallocation of
    res variable. As shown in the comment, intel_vsec_add_aux handles all
    the deallocation of res and feature_vsec_dev. Therefore, kfree(res) can
    still cause double free if intel_vsec_add_aux returns error.
    
    Fix this by adjusting the error handling part in tpmi_create_device,
    following the function intel_vsec_add_dev.
    
    Fixes: 6a192c0cbf38 ("platform/x86/intel/tpmi: Fix double free reported by Smatch")
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230309040107.534716-2-dzm91@hust.edu.cn
    Reviewed-by: Hans de Goede &lt;hdegoede@redhat.com&gt;
    Signed-off-by: Hans de Goede &lt;hdegoede@redhat.com&gt;

diff --git a/drivers/platform/x86/intel/tpmi.c b/drivers/platform/x86/intel/tpmi.c
index c999732b0f1e..a8733c43e4ab 100644
--- a/drivers/platform/x86/intel/tpmi.c
+++ b/drivers/platform/x86/intel/tpmi.c
@@ -203,7 +203,7 @@ static int tpmi_create_device(struct intel_tpmi_info *tpmi_info,
 	struct intel_vsec_device *feature_vsec_dev;
 	struct resource *res, *tmp;
 	const char *name;
-	int ret, i;
+	int i;
 
 	name = intel_tpmi_name(pfs-&gt;pfs_header.tpmi_id);
 	if (!name)
@@ -215,8 +215,8 @@ static int tpmi_create_device(struct intel_tpmi_info *tpmi_info,
 
 	feature_vsec_dev = kzalloc(sizeof(*feature_vsec_dev), GFP_KERNEL);
 	if (!feature_vsec_dev) {
-		ret = -ENOMEM;
-		goto free_res;
+		kfree(res);
+		return -ENOMEM;
 	}
 
 	snprintf(feature_id_name, sizeof(feature_id_name), "tpmi-%s", name);
@@ -242,17 +242,8 @@ static int tpmi_create_device(struct intel_tpmi_info *tpmi_info,
 	 * feature_vsec_dev memory is also freed as part of device
 	 * delete.
 	 */
-	ret = intel_vsec_add_aux(vsec_dev-&gt;pcidev, &amp;vsec_dev-&gt;auxdev.dev,
-				 feature_vsec_dev, feature_id_name);
-	if (ret)
-		goto free_res;
-
-	return 0;
-
-free_res:
-	kfree(res);
-
-	return ret;
+	return intel_vsec_add_aux(vsec_dev-&gt;pcidev, &amp;vsec_dev-&gt;auxdev.dev,
+				  feature_vsec_dev, feature_id_name);
 }
 
 static int tpmi_create_devices(struct intel_tpmi_info *tpmi_info)</pre><hr><pre>commit da0ba0ccce54059d6c6b788a75099bfce95126da
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Thu Mar 9 12:01:07 2023 +0800

    platform/x86/intel: vsec: Fix a memory leak in intel_vsec_add_aux
    
    The first error handling code in intel_vsec_add_aux misses the
    deallocation of intel_vsec_dev-&gt;resource.
    
    Fix this by adding kfree(intel_vsec_dev-&gt;resource) in the error handling
    code.
    
    Reviewed-by: David E. Box &lt;david.e.box@linux.intel.com&gt;
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230309040107.534716-4-dzm91@hust.edu.cn
    Reviewed-by: Hans de Goede &lt;hdegoede@redhat.com&gt;
    Signed-off-by: Hans de Goede &lt;hdegoede@redhat.com&gt;

diff --git a/drivers/platform/x86/intel/vsec.c b/drivers/platform/x86/intel/vsec.c
index 13decf36c6de..2311c16cb975 100644
--- a/drivers/platform/x86/intel/vsec.c
+++ b/drivers/platform/x86/intel/vsec.c
@@ -154,6 +154,7 @@ int intel_vsec_add_aux(struct pci_dev *pdev, struct device *parent,
 	ret = ida_alloc(intel_vsec_dev-&gt;ida, GFP_KERNEL);
 	mutex_unlock(&amp;vsec_ida_lock);
 	if (ret &lt; 0) {
+		kfree(intel_vsec_dev-&gt;resource);
 		kfree(intel_vsec_dev);
 		return ret;
 	}</pre><hr><pre>commit fb37fdd02856e45e78209d32522029c9f77fe7b7
Author: Cheng Ziqiu &lt;chengziqiu@hust.edu.cn&gt;
Date:   Tue Mar 14 15:01:30 2023 +0800

    iio: adc: at91-sama5d2_adc: remove dead code in at91_adc_probe()
    
    From the comment of platform_get_irq(), it only returns non-zero IRQ
    number and negative error number, other than zero.
    
    Fix this by removing the if condition.
    
    Signed-off-by: Cheng Ziqiu &lt;chengziqiu@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Claudiu Beznea &lt;claudiu.beznea@microchip.com&gt;
    Link: https://lore.kernel.org/r/20230314070130.60581-1-chengziqiu@hust.edu.cn
    Signed-off-by: Jonathan Cameron &lt;Jonathan.Cameron@huawei.com&gt;

diff --git a/drivers/iio/adc/at91-sama5d2_adc.c b/drivers/iio/adc/at91-sama5d2_adc.c
index b5d0c9ee284c..30554026a7fe 100644
--- a/drivers/iio/adc/at91-sama5d2_adc.c
+++ b/drivers/iio/adc/at91-sama5d2_adc.c
@@ -2400,12 +2400,8 @@ static int at91_adc_probe(struct platform_device *pdev)
 	st-&gt;dma_st.phys_addr = res-&gt;start;
 
 	st-&gt;irq = platform_get_irq(pdev, 0);
-	if (st-&gt;irq &lt;= 0) {
-		if (!st-&gt;irq)
-			st-&gt;irq = -ENXIO;
-
+	if (st-&gt;irq &lt; 0)
 		return st-&gt;irq;
-	}
 
 	st-&gt;per_clk = devm_clk_get(&amp;pdev-&gt;dev, "adc_clk");
 	if (IS_ERR(st-&gt;per_clk))</pre><hr><pre>commit 984cfd55e0c99e80b2e5b1dc6b2bf98608af7ff9
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Wed Mar 8 16:32:31 2023 +0800

    net: ieee802154: remove an unnecessary null pointer check
    
    llsec_parse_seclevel has the null pointer check at its begining. Compared
    with nl802154_add_llsec_seclevel, nl802154_del_llsec_seclevel has a
    redundant null pointer check of info-&gt;attrs[NL802154_ATTR_SEC_LEVEL]
    before llsec_parse_seclevel.
    
    Fix this issue by removing the null pointer check in
    nl802154_del_llsec_seclevel.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230308083231.460015-1-dzm91@hust.edu.cn
    Signed-off-by: Stefan Schmidt &lt;stefan@datenfreihafen.org&gt;

diff --git a/net/ieee802154/nl802154.c b/net/ieee802154/nl802154.c
index d8f4379d4fa6..832e3c50816c 100644
--- a/net/ieee802154/nl802154.c
+++ b/net/ieee802154/nl802154.c
@@ -2488,8 +2488,7 @@ static int nl802154_del_llsec_seclevel(struct sk_buff *skb,
 	if (wpan_dev-&gt;iftype == NL802154_IFTYPE_MONITOR)
 		return -EOPNOTSUPP;
 
-	if (!info-&gt;attrs[NL802154_ATTR_SEC_LEVEL] ||
-	    llsec_parse_seclevel(info-&gt;attrs[NL802154_ATTR_SEC_LEVEL],
+	if (llsec_parse_seclevel(info-&gt;attrs[NL802154_ATTR_SEC_LEVEL],
 				 &amp;sl) &lt; 0)
 		return -EINVAL;
 </pre><hr><pre>commit cbffe6b3b2bdf6064135f715242feb2f9094190f
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Mon Mar 6 10:45:23 2023 +0800

    i2c: davinci: remove dead code in probe
    
    From the comment of platform_get_irq, it only returns non-zero IRQ
    number and negative error number, other than zero.
    
    Fix this by removing the if condition.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Bartosz Golaszewski &lt;bartosz.golaszewski@linaro.org&gt;
    Signed-off-by: Wolfram Sang &lt;wsa@kernel.org&gt;

diff --git a/drivers/i2c/busses/i2c-davinci.c b/drivers/i2c/busses/i2c-davinci.c
index c836cf884185..9750310f2c96 100644
--- a/drivers/i2c/busses/i2c-davinci.c
+++ b/drivers/i2c/busses/i2c-davinci.c
@@ -764,11 +764,8 @@ static int davinci_i2c_probe(struct platform_device *pdev)
 	int r, irq;
 
 	irq = platform_get_irq(pdev, 0);
-	if (irq &lt;= 0) {
-		if (!irq)
-			irq = -ENXIO;
+	if (irq &lt; 0)
 		return dev_err_probe(&amp;pdev-&gt;dev, irq, "can't get irq resource\n");
-	}
 
 	dev = devm_kzalloc(&amp;pdev-&gt;dev, sizeof(struct davinci_i2c_dev),
 			GFP_KERNEL);</pre><hr><pre>commit 4fa1387261e725a418066f8f46ea87a6ba0e5be1
Author: Yalong Zou &lt;yalongz@hust.edu.cn&gt;
Date:   Thu Mar 9 23:08:15 2023 +0800

    usb: remove dead code in dwc3_gadget_get_irq
    
    platform_get_irq() only return non-zero irq number on success, or
    negative error number on failure.
    
    There is no need to check the return value of platform_get_irq()
    to determine the return value of dwc3_gadget_get_irq(), removing
    them to solve this problem.
    
    Signed-off-by: Yalong Zou &lt;yalongz@hust.edu.cn&gt;
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230309150815.1884260-1-yalongz@hust.edu.cn
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;

diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index 07989c645a94..a1ebb30c15fa 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -4402,11 +4402,6 @@ static int dwc3_gadget_get_irq(struct dwc3 *dwc)
 		goto out;
 
 	irq = platform_get_irq(dwc3_pdev, 0);
-	if (irq &gt; 0)
-		goto out;
-
-	if (!irq)
-		irq = -EINVAL;
 
 out:
 	return irq;</pre>
    <div class="pagination">
        <a href='17_5.html'>&lt;&lt;Prev</a><a href='17.html'>1</a><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><a href='17_5.html'>5</a><span>[6]</span><a href='17_7.html'>7</a><a href='17_7.html'>Next&gt;&gt;</a>
    <div>
</body>
