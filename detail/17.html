<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Huazhong University of Science and Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Huazhong University of Science and Technology</h1>
    <div class="pagination">
        <span>[1]</span><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><a href='17_5.html'>5</a><a href='17_6.html'>6</a><a href='17_7.html'>7</a><a href='17_2.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit bcdbd6f607bacb51743ac73f13f40d015cb9de53
Author: RutingZhang &lt;u202112078@hust.edu.cn&gt;
Date:   Tue Nov 21 12:36:20 2023 +0800

    drm/amd/display: remove unnecessary braces to fix coding style
    
    checkpatch complains that:
    
    WARNING: braces {} are not necessary for single statement blocks
    +                if (pool-&gt;base.irqs != NULL) {
    +                        dal_irq_service_destroy(&amp;pool-&gt;base.irqs);
    +                }
    
    Fixed it by removing unnecessary braces to fix the coding style issue.
    
    Signed-off-by: RutingZhang &lt;u202112078@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Signed-off-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;

diff --git a/drivers/gpu/drm/amd/display/dc/resource/dcn21/dcn21_resource.c b/drivers/gpu/drm/amd/display/dc/resource/dcn21/dcn21_resource.c
index c07da45e1e2c..65d337731f56 100644
--- a/drivers/gpu/drm/amd/display/dc/resource/dcn21/dcn21_resource.c
+++ b/drivers/gpu/drm/amd/display/dc/resource/dcn21/dcn21_resource.c
@@ -713,9 +713,8 @@ static void dcn21_resource_destruct(struct dcn21_resource_pool *pool)
 			pool-&gt;base.hubps[i] = NULL;
 		}
 
-		if (pool-&gt;base.irqs != NULL) {
+		if (pool-&gt;base.irqs != NULL)
 			dal_irq_service_destroy(&amp;pool-&gt;base.irqs);
-		}
 	}
 
 	for (i = 0; i &lt; pool-&gt;base.res_cap-&gt;num_ddc; i++) {</pre><hr><pre>commit daacef89cd1bb7e345539db10e979e1b78451591
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Fri Sep 1 14:25:48 2023 +0800

    soc: loongson: loongson2_guts: Convert to devm_platform_ioremap_resource()
    
    Use devm_platform_ioremap_resource() to simplify code.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Signed-off-by: Binbin Zhou &lt;zhoubinbin@loongson.cn&gt;
    Signed-off-by: Arnd Bergmann &lt;arnd@arndb.de&gt;

diff --git a/drivers/soc/loongson/loongson2_guts.c b/drivers/soc/loongson/loongson2_guts.c
index bace4bc8e03b..d97c77a9a4a2 100644
--- a/drivers/soc/loongson/loongson2_guts.c
+++ b/drivers/soc/loongson/loongson2_guts.c
@@ -94,7 +94,6 @@ static int loongson2_guts_probe(struct platform_device *pdev)
 {
 	struct device_node *root, *np = pdev-&gt;dev.of_node;
 	struct device *dev = &amp;pdev-&gt;dev;
-	struct resource *res;
 	const struct loongson2_soc_die_attr *soc_die;
 	const char *machine;
 	u32 svr;
@@ -106,8 +105,7 @@ static int loongson2_guts_probe(struct platform_device *pdev)
 
 	guts-&gt;little_endian = of_property_read_bool(np, "little-endian");
 
-	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
-	guts-&gt;regs = ioremap(res-&gt;start, res-&gt;end - res-&gt;start + 1);
+	guts-&gt;regs = devm_platform_ioremap_resource(pdev, 0);
 	if (IS_ERR(guts-&gt;regs))
 		return PTR_ERR(guts-&gt;regs);
 </pre><hr><pre>commit dc73b20593544f8e1b78dded909296f2777076d0
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Tue Sep 5 09:35:56 2023 +0800

    wifi: ath9k: clean up function ath9k_hif_usb_resume
    
    In ath9k_hif_usb_resume, the error handling code calls
    ath9k_hif_usb_dealloc_urbs twice in different paths.
    
    To unify the error handling code, we move the else branch before
    the if branch and drop one level of indentation of the if branch.
    
    In addition, move the ret variable at the end of variable declarations
    to be reverse x-mas tree order.
    
    Note that this patch does not incur any functionability change.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;dan.carpenter@linaro.org&gt;
    Acked-by: Toke Høiland-Jørgensen &lt;toke@toke.dk&gt;
    Signed-off-by: Kalle Valo &lt;quic_kvalo@quicinc.com&gt;
    Link: https://lore.kernel.org/r/20230905013556.2595854-1-dzm91@hust.edu.cn

diff --git a/drivers/net/wireless/ath/ath9k/hif_usb.c b/drivers/net/wireless/ath/ath9k/hif_usb.c
index e5414435b141..90cfe39aa433 100644
--- a/drivers/net/wireless/ath/ath9k/hif_usb.c
+++ b/drivers/net/wireless/ath/ath9k/hif_usb.c
@@ -1481,31 +1481,31 @@ static int ath9k_hif_usb_resume(struct usb_interface *interface)
 {
 	struct hif_device_usb *hif_dev = usb_get_intfdata(interface);
 	struct htc_target *htc_handle = hif_dev-&gt;htc_handle;
-	int ret;
 	const struct firmware *fw;
+	int ret;
 
 	ret = ath9k_hif_usb_alloc_urbs(hif_dev);
 	if (ret)
 		return ret;
 
-	if (hif_dev-&gt;flags &amp; HIF_USB_READY) {
-		/* request cached firmware during suspend/resume cycle */
-		ret = request_firmware(&amp;fw, hif_dev-&gt;fw_name,
-				       &amp;hif_dev-&gt;udev-&gt;dev);
-		if (ret)
-			goto fail_resume;
-
-		hif_dev-&gt;fw_data = fw-&gt;data;
-		hif_dev-&gt;fw_size = fw-&gt;size;
-		ret = ath9k_hif_usb_download_fw(hif_dev);
-		release_firmware(fw);
-		if (ret)
-			goto fail_resume;
-	} else {
-		ath9k_hif_usb_dealloc_urbs(hif_dev);
-		return -EIO;
+	if (!(hif_dev-&gt;flags &amp; HIF_USB_READY)) {
+		ret = -EIO;
+		goto fail_resume;
 	}
 
+	/* request cached firmware during suspend/resume cycle */
+	ret = request_firmware(&amp;fw, hif_dev-&gt;fw_name,
+			       &amp;hif_dev-&gt;udev-&gt;dev);
+	if (ret)
+		goto fail_resume;
+
+	hif_dev-&gt;fw_data = fw-&gt;data;
+	hif_dev-&gt;fw_size = fw-&gt;size;
+	ret = ath9k_hif_usb_download_fw(hif_dev);
+	release_firmware(fw);
+	if (ret)
+		goto fail_resume;
+
 	mdelay(100);
 
 	ret = ath9k_htc_resume(htc_handle);</pre><hr><pre>commit 99e25b17d2a3e3b486b4f6f90a740d51245da1f2
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Wed Nov 16 09:45:50 2022 +0800

    pcmcia: typo fix
    
    themselfves -&gt; themselves
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Signed-off-by: Dominik Brodowski &lt;linux@dominikbrodowski.net&gt;

diff --git a/drivers/pcmcia/pcmcia_resource.c b/drivers/pcmcia/pcmcia_resource.c
index d78091e79a0f..e9e31c638a67 100644
--- a/drivers/pcmcia/pcmcia_resource.c
+++ b/drivers/pcmcia/pcmcia_resource.c
@@ -684,7 +684,7 @@ EXPORT_SYMBOL(pcmcia_request_io);
  * pcmcia_request_irq() is a wrapper around request_irq() which allows
  * the PCMCIA core to clean up the registration in pcmcia_disable_device().
  * Drivers are free to use request_irq() directly, but then they need to
- * call free_irq() themselfves, too. Also, only %IRQF_SHARED capable IRQ
+ * call free_irq() themselves, too. Also, only %IRQF_SHARED capable IRQ
  * handlers are allowed.
  */
 int __must_check pcmcia_request_irq(struct pcmcia_device *p_dev,</pre><hr><pre>commit 1d40165047456923fa4343d519353d9440cd68df
Author: Guoqing Cai &lt;u202112087@hust.edu.cn&gt;
Date:   Thu Apr 13 17:57:39 2023 +0800

    fs: jbd2: fix an incorrect warn log
    
    In jbd2_journal_load(), when journal_reset fails, it prints an incorrect
    warn log.
    
    Fix this by changing the goto statement to return statement.
    
    Also, return actual error code from jbd2_journal_recover() and journal_reset().
    
    Signed-off-by: Guoqing Cai &lt;u202112087@hust.edu.cn&gt;
    Reviewed-by: Jan Kara &lt;jack@suse.cz&gt;
    Link: https://lore.kernel.org/r/20230413095740.2222066-1-u202112087@hust.edu.cn
    Signed-off-by: Theodore Ts'o &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index fbce16fedaa4..5c223032f77a 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -2089,8 +2089,11 @@ int jbd2_journal_load(journal_t *journal)
 
 	/* Let the recovery code check whether it needs to recover any
 	 * data from the journal. */
-	if (jbd2_journal_recover(journal))
-		goto recovery_error;
+	err = jbd2_journal_recover(journal);
+	if (err) {
+		pr_warn("JBD2: journal recovery failed\n");
+		return err;
+	}
 
 	if (journal-&gt;j_failed_commit) {
 		printk(KERN_ERR "JBD2: journal transaction %u on %s "
@@ -2107,15 +2110,14 @@ int jbd2_journal_load(journal_t *journal)
 	/* OK, we've finished with the dynamic journal bits:
 	 * reinitialise the dynamic contents of the superblock in memory
 	 * and reset them on disk. */
-	if (journal_reset(journal))
-		goto recovery_error;
+	err = journal_reset(journal);
+	if (err) {
+		pr_warn("JBD2: journal reset failed\n");
+		return err;
+	}
 
 	journal-&gt;j_flags |= JBD2_LOADED;
 	return 0;
-
-recovery_error:
-	printk(KERN_WARNING "JBD2: recovery failed\n");
-	return -EIO;
 }
 
 /**</pre><hr><pre>commit 061115fbfb2ce5870c9a004d68dc63138c07c782
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Sun Jul 23 12:04:02 2023 +0800

    wifi: ath9k: fix printk specifier
    
    Smatch reports:
    
    ath_pci_probe() warn: argument 4 to %lx specifier is cast from pointer
    ath_ahb_probe() warn: argument 4 to %lx specifier is cast from pointer
    
    Fix it by modifying %lx to %p in the printk format string.
    
    Note that with this change, the pointer address will be printed as a
    hashed value by default. This is appropriate because the kernel
    should not leak kernel pointers to user space in an informational
    message. If someone wants to see the real address for debugging
    purposes, this can be achieved with the no_hash_pointers kernel option.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Acked-by: Toke Høiland-Jørgensen &lt;toke@toke.dk&gt;
    Signed-off-by: Kalle Valo &lt;quic_kvalo@quicinc.com&gt;
    Link: https://lore.kernel.org/r/20230723040403.296723-1-dzm91@hust.edu.cn

diff --git a/drivers/net/wireless/ath/ath9k/ahb.c b/drivers/net/wireless/ath/ath9k/ahb.c
index 9cd12b20b18d..9bfaadfa6c00 100644
--- a/drivers/net/wireless/ath/ath9k/ahb.c
+++ b/drivers/net/wireless/ath/ath9k/ahb.c
@@ -132,8 +132,8 @@ static int ath_ahb_probe(struct platform_device *pdev)
 
 	ah = sc-&gt;sc_ah;
 	ath9k_hw_name(ah, hw_name, sizeof(hw_name));
-	wiphy_info(hw-&gt;wiphy, "%s mem=0x%lx, irq=%d\n",
-		   hw_name, (unsigned long)mem, irq);
+	wiphy_info(hw-&gt;wiphy, "%s mem=0x%p, irq=%d\n",
+		   hw_name, mem, irq);
 
 	return 0;
 
diff --git a/drivers/net/wireless/ath/ath9k/pci.c b/drivers/net/wireless/ath/ath9k/pci.c
index a09f9d223f3d..0633589b85c2 100644
--- a/drivers/net/wireless/ath/ath9k/pci.c
+++ b/drivers/net/wireless/ath/ath9k/pci.c
@@ -988,8 +988,8 @@ static int ath_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	sc-&gt;sc_ah-&gt;msi_reg = 0;
 
 	ath9k_hw_name(sc-&gt;sc_ah, hw_name, sizeof(hw_name));
-	wiphy_info(hw-&gt;wiphy, "%s mem=0x%lx, irq=%d\n",
-		   hw_name, (unsigned long)sc-&gt;mem, pdev-&gt;irq);
+	wiphy_info(hw-&gt;wiphy, "%s mem=0x%p, irq=%d\n",
+		   hw_name, sc-&gt;mem, pdev-&gt;irq);
 
 	return 0;
 </pre><hr><pre>commit b9c7141f384097fa4fa67d2f72e5731d628aef7c
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Mon Feb 27 18:24:08 2023 +0800

    drivers: usb: smsusb: fix error handling code in smsusb_init_device
    
    The previous commit 4b208f8b561f ("[media] siano: register media controller
    earlier")moves siano_media_device_register before smscore_register_device,
    and adds corresponding error handling code if smscore_register_device
    fails. However, it misses the following error handling code of
    smsusb_init_device.
    
    Fix this by moving error handling code at the end of smsusb_init_device
    and adding a goto statement in the following error handling parts.
    
    Fixes: 4b208f8b561f ("[media] siano: register media controller earlier")
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;

diff --git a/drivers/media/usb/siano/smsusb.c b/drivers/media/usb/siano/smsusb.c
index 640737d3b8ae..8a39cac76c58 100644
--- a/drivers/media/usb/siano/smsusb.c
+++ b/drivers/media/usb/siano/smsusb.c
@@ -455,12 +455,7 @@ static int smsusb_init_device(struct usb_interface *intf, int board_id)
 	rc = smscore_register_device(&amp;params, &amp;dev-&gt;coredev, 0, mdev);
 	if (rc &lt; 0) {
 		pr_err("smscore_register_device(...) failed, rc %d\n", rc);
-		smsusb_term_device(intf);
-#ifdef CONFIG_MEDIA_CONTROLLER_DVB
-		media_device_unregister(mdev);
-#endif
-		kfree(mdev);
-		return rc;
+		goto err_unregister_device;
 	}
 
 	smscore_set_board_id(dev-&gt;coredev, board_id);
@@ -477,8 +472,7 @@ static int smsusb_init_device(struct usb_interface *intf, int board_id)
 	rc = smsusb_start_streaming(dev);
 	if (rc &lt; 0) {
 		pr_err("smsusb_start_streaming(...) failed\n");
-		smsusb_term_device(intf);
-		return rc;
+		goto err_unregister_device;
 	}
 
 	dev-&gt;state = SMSUSB_ACTIVE;
@@ -486,13 +480,20 @@ static int smsusb_init_device(struct usb_interface *intf, int board_id)
 	rc = smscore_start_device(dev-&gt;coredev);
 	if (rc &lt; 0) {
 		pr_err("smscore_start_device(...) failed\n");
-		smsusb_term_device(intf);
-		return rc;
+		goto err_unregister_device;
 	}
 
 	pr_debug("device 0x%p created\n", dev);
 
 	return rc;
+
+err_unregister_device:
+	smsusb_term_device(intf);
+#ifdef CONFIG_MEDIA_CONTROLLER_DVB
+	media_device_unregister(mdev);
+#endif
+	kfree(mdev);
+	return rc;
 }
 
 static int smsusb_probe(struct usb_interface *intf,</pre><hr><pre>commit cd9489623c29aa2f8cc07088168afb6e0d5ef06d
Author: Shuai Jiang &lt;d202180596@hust.edu.cn&gt;
Date:   Tue Apr 18 21:56:12 2023 +0800

    i2c: qup: Add missing unwind goto in qup_i2c_probe()
    
    Smatch Warns:
            drivers/i2c/busses/i2c-qup.c:1784 qup_i2c_probe()
            warn: missing unwind goto?
    
    The goto label "fail_runtime" and "fail" will disable qup-&gt;pclk,
    but here qup-&gt;pclk failed to obtain, in order to be consistent,
    change the direct return to goto label "fail_dma".
    
    Fixes: 9cedf3b2f099 ("i2c: qup: Add bam dma capabilities")
    Signed-off-by: Shuai Jiang &lt;d202180596@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Andi Shyti &lt;andi.shyti@kernel.org&gt;
    Signed-off-by: Wolfram Sang &lt;wsa@kernel.org&gt;
    Cc: &lt;stable@vger.kernel.org&gt; # v4.6+

diff --git a/drivers/i2c/busses/i2c-qup.c b/drivers/i2c/busses/i2c-qup.c
index 2e153f2f71b6..78682388e02e 100644
--- a/drivers/i2c/busses/i2c-qup.c
+++ b/drivers/i2c/busses/i2c-qup.c
@@ -1752,16 +1752,21 @@ static int qup_i2c_probe(struct platform_device *pdev)
 	if (!clk_freq || clk_freq &gt; I2C_MAX_FAST_MODE_PLUS_FREQ) {
 		dev_err(qup-&gt;dev, "clock frequency not supported %d\n",
 			clk_freq);
-		return -EINVAL;
+		ret = -EINVAL;
+		goto fail_dma;
 	}
 
 	qup-&gt;base = devm_platform_ioremap_resource(pdev, 0);
-	if (IS_ERR(qup-&gt;base))
-		return PTR_ERR(qup-&gt;base);
+	if (IS_ERR(qup-&gt;base)) {
+		ret = PTR_ERR(qup-&gt;base);
+		goto fail_dma;
+	}
 
 	qup-&gt;irq = platform_get_irq(pdev, 0);
-	if (qup-&gt;irq &lt; 0)
-		return qup-&gt;irq;
+	if (qup-&gt;irq &lt; 0) {
+		ret = qup-&gt;irq;
+		goto fail_dma;
+	}
 
 	if (has_acpi_companion(qup-&gt;dev)) {
 		ret = device_property_read_u32(qup-&gt;dev,
@@ -1775,13 +1780,15 @@ static int qup_i2c_probe(struct platform_device *pdev)
 		qup-&gt;clk = devm_clk_get(qup-&gt;dev, "core");
 		if (IS_ERR(qup-&gt;clk)) {
 			dev_err(qup-&gt;dev, "Could not get core clock\n");
-			return PTR_ERR(qup-&gt;clk);
+			ret = PTR_ERR(qup-&gt;clk);
+			goto fail_dma;
 		}
 
 		qup-&gt;pclk = devm_clk_get(qup-&gt;dev, "iface");
 		if (IS_ERR(qup-&gt;pclk)) {
 			dev_err(qup-&gt;dev, "Could not get iface clock\n");
-			return PTR_ERR(qup-&gt;pclk);
+			ret = PTR_ERR(qup-&gt;pclk);
+			goto fail_dma;
 		}
 		qup_i2c_enable_clocks(qup);
 		src_clk_freq = clk_get_rate(qup-&gt;clk);</pre><hr><pre>commit 9e1a1ee93f6b08aad5ee645073f7c7b115f71e15
Author: Wang Zhang &lt;silver_code@hust.edu.cn&gt;
Date:   Fri May 26 15:05:33 2023 +0800

    i2c: ocores: use devm_ managed clks
    
    Smatch complains that:
    drivers/i2c/busses/i2c-ocores.c:704 ocores_i2c_probe()
    warn: missing unwind goto?
    
    If any wrong occurs in ocores_i2c_of_probe, the i2c-&gt;clk needs to be
    released. But the function returns directly without freeing the clock.
    
    Fix this by updating the code to use devm_clk_get_optional_enabled()
    instead. Use dev_err_probe() where appropriate as well since we are
    changing those statements.
    
    Fixes: f5f35a92e44a ("i2c: ocores: Add irq support for sparc")
    Signed-off-by: Wang Zhang &lt;silver_code@hust.edu.cn&gt;
    Reviewed-by: Andi Shyti &lt;andi.shyti@kernel.org&gt;
    Reviewed-by: Andrew Lunn &lt;andrew@lunn.ch&gt;
    Signed-off-by: Wolfram Sang &lt;wsa@kernel.org&gt;

diff --git a/drivers/i2c/busses/i2c-ocores.c b/drivers/i2c/busses/i2c-ocores.c
index 0742b84a11eb..4ac77e57bbbf 100644
--- a/drivers/i2c/busses/i2c-ocores.c
+++ b/drivers/i2c/busses/i2c-ocores.c
@@ -552,28 +552,20 @@ static int ocores_i2c_of_probe(struct platform_device *pdev,
 							&amp;clock_frequency);
 	i2c-&gt;bus_clock_khz = 100;
 
-	i2c-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, NULL);
-
-	if (!IS_ERR(i2c-&gt;clk)) {
-		int ret = clk_prepare_enable(i2c-&gt;clk);
-
-		if (ret) {
-			dev_err(&amp;pdev-&gt;dev,
-				"clk_prepare_enable failed: %d\n", ret);
-			return ret;
-		}
-		i2c-&gt;ip_clock_khz = clk_get_rate(i2c-&gt;clk) / 1000;
-		if (clock_frequency_present)
-			i2c-&gt;bus_clock_khz = clock_frequency / 1000;
-	}
-
+	i2c-&gt;clk = devm_clk_get_optional_enabled(&amp;pdev-&gt;dev, NULL);
+	if (IS_ERR(i2c-&gt;clk))
+		return dev_err_probe(&amp;pdev-&gt;dev, PTR_ERR(i2c-&gt;clk),
+				     "devm_clk_get_optional_enabled failed\n");
+
+	i2c-&gt;ip_clock_khz = clk_get_rate(i2c-&gt;clk) / 1000;
+	if (clock_frequency_present)
+		i2c-&gt;bus_clock_khz = clock_frequency / 1000;
 	if (i2c-&gt;ip_clock_khz == 0) {
 		if (of_property_read_u32(np, "opencores,ip-clock-frequency",
 						&amp;val)) {
 			if (!clock_frequency_present) {
 				dev_err(&amp;pdev-&gt;dev,
 					"Missing required parameter 'opencores,ip-clock-frequency'\n");
-				clk_disable_unprepare(i2c-&gt;clk);
 				return -ENODEV;
 			}
 			i2c-&gt;ip_clock_khz = clock_frequency / 1000;
@@ -678,8 +670,7 @@ static int ocores_i2c_probe(struct platform_device *pdev)
 		default:
 			dev_err(&amp;pdev-&gt;dev, "Unsupported I/O width (%d)\n",
 				i2c-&gt;reg_io_width);
-			ret = -EINVAL;
-			goto err_clk;
+			return -EINVAL;
 		}
 	}
 
@@ -710,13 +701,13 @@ static int ocores_i2c_probe(struct platform_device *pdev)
 						   pdev-&gt;name, i2c);
 		if (ret) {
 			dev_err(&amp;pdev-&gt;dev, "Cannot claim IRQ\n");
-			goto err_clk;
+			return ret;
 		}
 	}
 
 	ret = ocores_init(&amp;pdev-&gt;dev, i2c);
 	if (ret)
-		goto err_clk;
+		return ret;
 
 	/* hook up driver to tree */
 	platform_set_drvdata(pdev, i2c);
@@ -728,7 +719,7 @@ static int ocores_i2c_probe(struct platform_device *pdev)
 	/* add i2c adapter to i2c tree */
 	ret = i2c_add_adapter(&amp;i2c-&gt;adap);
 	if (ret)
-		goto err_clk;
+		return ret;
 
 	/* add in known devices to the bus */
 	if (pdata) {
@@ -737,10 +728,6 @@ static int ocores_i2c_probe(struct platform_device *pdev)
 	}
 
 	return 0;
-
-err_clk:
-	clk_disable_unprepare(i2c-&gt;clk);
-	return ret;
 }
 
 static void ocores_i2c_remove(struct platform_device *pdev)
@@ -754,9 +741,6 @@ static void ocores_i2c_remove(struct platform_device *pdev)
 
 	/* remove adapter &amp; data */
 	i2c_del_adapter(&amp;i2c-&gt;adap);
-
-	if (!IS_ERR(i2c-&gt;clk))
-		clk_disable_unprepare(i2c-&gt;clk);
 }
 
 #ifdef CONFIG_PM_SLEEP
@@ -769,28 +753,22 @@ static int ocores_i2c_suspend(struct device *dev)
 	ctrl &amp;= ~(OCI2C_CTRL_EN | OCI2C_CTRL_IEN);
 	oc_setreg(i2c, OCI2C_CONTROL, ctrl);
 
-	if (!IS_ERR(i2c-&gt;clk))
-		clk_disable_unprepare(i2c-&gt;clk);
+	clk_disable_unprepare(i2c-&gt;clk);
 	return 0;
 }
 
 static int ocores_i2c_resume(struct device *dev)
 {
 	struct ocores_i2c *i2c = dev_get_drvdata(dev);
+	unsigned long rate;
+	int ret;
 
-	if (!IS_ERR(i2c-&gt;clk)) {
-		unsigned long rate;
-		int ret = clk_prepare_enable(i2c-&gt;clk);
-
-		if (ret) {
-			dev_err(dev,
-				"clk_prepare_enable failed: %d\n", ret);
-			return ret;
-		}
-		rate = clk_get_rate(i2c-&gt;clk) / 1000;
-		if (rate)
-			i2c-&gt;ip_clock_khz = rate;
-	}
+	ret = clk_prepare_enable(i2c-&gt;clk);
+	if (ret)
+		return dev_err_probe(dev, ret, "clk_prepare_enable failed\n");
+	rate = clk_get_rate(i2c-&gt;clk) / 1000;
+	if (rate)
+		i2c-&gt;ip_clock_khz = rate;
 	return ocores_init(dev, i2c);
 }
 </pre><hr><pre>commit 8b5bf64c89c7100c921bd807ba39b2eb003061ab
Author: Feng Mingxi &lt;m202271825@hust.edu.cn&gt;
Date:   Tue Apr 25 06:56:11 2023 +0000

    clocksource/drivers/cadence-ttc: Fix memory leak in ttc_timer_probe
    
    Smatch reports:
    drivers/clocksource/timer-cadence-ttc.c:529 ttc_timer_probe()
    warn: 'timer_baseaddr' from of_iomap() not released on lines: 498,508,516.
    
    timer_baseaddr may have the problem of not being released after use,
    I replaced it with the devm_of_iomap() function and added the clk_put()
    function to cleanup the "clk_ce" and "clk_cs".
    
    Fixes: e932900a3279 ("arm: zynq: Use standard timer binding")
    Fixes: 70504f311d4b ("clocksource/drivers/cadence_ttc: Convert init function to return error")
    Signed-off-by: Feng Mingxi &lt;m202271825@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Acked-by: Michal Simek &lt;michal.simek@amd.com&gt;
    Signed-off-by: Daniel Lezcano &lt;daniel.lezcano@linaro.org&gt;
    Link: https://lore.kernel.org/r/20230425065611.702917-1-m202271825@hust.edu.cn

diff --git a/drivers/clocksource/timer-cadence-ttc.c b/drivers/clocksource/timer-cadence-ttc.c
index 4efd0cf3b602..0d52e28fea4d 100644
--- a/drivers/clocksource/timer-cadence-ttc.c
+++ b/drivers/clocksource/timer-cadence-ttc.c
@@ -486,10 +486,10 @@ static int __init ttc_timer_probe(struct platform_device *pdev)
 	 * and use it. Note that the event timer uses the interrupt and it's the
 	 * 2nd TTC hence the irq_of_parse_and_map(,1)
 	 */
-	timer_baseaddr = of_iomap(timer, 0);
-	if (!timer_baseaddr) {
+	timer_baseaddr = devm_of_iomap(&amp;pdev-&gt;dev, timer, 0, NULL);
+	if (IS_ERR(timer_baseaddr)) {
 		pr_err("ERROR: invalid timer base address\n");
-		return -ENXIO;
+		return PTR_ERR(timer_baseaddr);
 	}
 
 	irq = irq_of_parse_and_map(timer, 1);
@@ -513,20 +513,27 @@ static int __init ttc_timer_probe(struct platform_device *pdev)
 	clk_ce = of_clk_get(timer, clksel);
 	if (IS_ERR(clk_ce)) {
 		pr_err("ERROR: timer input clock not found\n");
-		return PTR_ERR(clk_ce);
+		ret = PTR_ERR(clk_ce);
+		goto put_clk_cs;
 	}
 
 	ret = ttc_setup_clocksource(clk_cs, timer_baseaddr, timer_width);
 	if (ret)
-		return ret;
+		goto put_clk_ce;
 
 	ret = ttc_setup_clockevent(clk_ce, timer_baseaddr + 4, irq);
 	if (ret)
-		return ret;
+		goto put_clk_ce;
 
 	pr_info("%pOFn #0 at %p, irq=%d\n", timer, timer_baseaddr, irq);
 
 	return 0;
+
+put_clk_ce:
+	clk_put(clk_ce);
+put_clk_cs:
+	clk_put(clk_cs);
+	return ret;
 }
 
 static const struct of_device_id ttc_timer_of_match[] = {</pre>
    <div class="pagination">
        <span>[1]</span><a href='17_2.html'>2</a><a href='17_3.html'>3</a><a href='17_4.html'>4</a><a href='17_5.html'>5</a><a href='17_6.html'>6</a><a href='17_7.html'>7</a><a href='17_2.html'>Next&gt;&gt;</a>
    <div>
</body>
